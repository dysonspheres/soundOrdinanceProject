---
output:
  reprex::reprex_document:
    venue: "gh"
    advertise: FALSE
    session_info: TRUE
    style: TRUE
    comment: "#;-)"
    tidyverse_quiet: FALSE
    std_out_err: TRUE
knit: reprex::reprex_render
---

## Data Cleaning

We decided to remove these columns: CASE_TYPE, FOLDER_TYPE, WORK, PERMIT_NUMBER, REFERENCEFILE, FOLDERRSN, LINK, APPLICANT_FIRST_NAME, APPLICANT_LAST_NAME, END_HOURS_MOV_VEH_MON_SAT, END_HOURS_MOV_VEH_SUN, PROPERTYRSN, START_HOURS_MOV_VEH_MON_SAT, START_HOURS_MOV_VEH_SUN, PROPX, PROPY, LOCATION, UPDATE_DATE, FOLDER_DESCRIPTION

```{r, echo=FALSE, results="hide", message="hide"}
# install.packages("dplyr")  # this was for Nneoma, since it wasn't working for you
library(dplyr)

df <- read.csv("sound_ordinance_data.csv", na.strings = c("", "NA")) # ensured that blank strings are counting as NA

columns_to_remove <- c(
  "CASE_TYPE", "FOLDER_TYPE", "WORK", "PERMIT_NUMBER", "REFERENCEFILE", "FOLDERRSN", "LINK",
  "APPLICANT_FIRST_NAME", "APPLICANT_LAST_NAME", "END_HOURS_MOV_VEH_MON_SAT", "END_HOURS_MOV_VEH_SUN",
  "PROPERTYRSN", "START_HOURS_MOV_VEH_MON_SAT", "START_HOURS_MOV_VEH_SUN", "PROPX", "PROPY", "LOCATION", "UPDATE_DATE", "FOLDER_DESCRIPTION",
  "FOLDER_NAME", "EVENT_YEAR", "APPLICANT_ORGANIZATION", "START_DATE_3", "START_DATE_4"
)
df <- df %>% select(-all_of(columns_to_remove))


df <- df %>% rename(EVENT_YEAR = CALENDAR_YEAR_FOLDER_CREATED)
df <- df %>% filter(!is.na(COUNCIL_DISTRICT))
df <- df %>% filter(!is.na(EVENT_YEAR))
df <- df %>% filter(!is.na(EXISTING_ZONING))
df <- df %>% filter(!is.na(ISSUED_BY))
# df <- df %>% filter(!is.na(START_HOURS_CONC_POUR_MON_SAT))
# df <- df %>% filter(!is.na(END_HOURS_CONC_POUR_MON_SAT))

# unique_counts <- sapply(df, function(col), length(unique(col)))
# print(unique_counts)


df$START_DATE_2 <- !(df$START_DATE_2 == "" | is.na(df$START_DATE_2)) # flipped it to make majority of set false instead of true


df <- df %>% rename(MULTIPLE_START_DATES = START_DATE_2)

unique_values <- unique(df$EVENT_MONTH)
# unique_values <- unique(df$OMV_TUE_START_TIME)
unique_values

# table(df$OMV_TUE_END_TIME)
# table(df$ISSUED_BY)

df %>% summarize(n())

sum(colSums(is.na(df)))
```

The convert_time method will be used to change hours into numbers

```{r}
# Nneoma's convert time method
# Function to convert time strings to numbers - if values dont have am or pm, it will return -100
convert_time <- function(time) {
  if (is.na(time) || time == "NA") { # returns null values
    return(NA)
  }
  time <- trimws(tolower(time)) # Make everything lowercase and remove extra spaces
  if (time == "midnight") {
    return(0)
  }
  if (time == "noon") {
    return(12)
  }

  time <- gsub("[[:space:].,]", "", tolower(time)) # Normalize time by removing spaces and periods

  am_or_pm <- substr(time, nchar(time) - 1, nchar(time)) # Check if the string ends with "am" or "pm"
  time <- gsub(am_or_pm, "", time) # removes the end
  # Handle times like "6:30", "9:45", etc., by extracting only the hour
  if (grepl(":", time)) {
    time <- sub(":.*", "", time) # Remove minutes, keep the hour part
  }

  if (am_or_pm == "am") {
    # time <- sub("am", "", time)  # Remove 'am'
    # time <- trimws(time)  # Trim extra spaces
    if (time == "" || time == "12" || time == "midnight") {
      return(0) # If it's "12am", return 0
    }
    return(as.numeric(time))
  } else if (am_or_pm == "pm") {
    # hour <- as.numeric(time)
    if (time == "12" || time == "noon") {
      return(12) # If it's "12pm", return 12
    }
    return(as.numeric(time) + 12) # Add 12 for PM times
  } else {
    return(-100) # If time format is unrecognized, return an error
  }
}
```

# Greg

```{r, echo=FALSE}
# GREG

df$START_HOURS_CONC_POUR_MON_SAT <- sapply(df$START_HOURS_CONC_POUR_MON_SAT, convert_time)
df$END_HOURS_CONC_POUR_MON_SAT <- sapply(df$END_HOURS_CONC_POUR_MON_SAT, convert_time)

sum(is.na(df$LONGITUDE)) # Count NA values for LONGITUDE
sum(is.na(df$ZIPCODE)) # Count NA values for ZIPCODE
sum(is.na(df$LATITUDE)) # Count NA values for LATITUDE
sum(is.na(df$COUNCIL_DISTRICT)) # Count NA values for COUNCIL_DISTRICT

df %>% summarize(n())
```

```{r}
# ESHI
df$START_HOURS_NEAR_HOME_FRI_SAT <- sapply(df$START_HOURS_NEAR_HOME_FRI_SAT, convert_time)
# df <- df[df$START_HOURS_NEAR_HOME_FRI_SAT != "-100", ]
df %>% summarize(n())
df$START_HOURS_NEAR_HOME_FRI_SAT <- ifelse(df$START_HOURS_NEAR_HOME_FRI_SAT == -100, NA, df$START_HOURS_NEAR_HOME_FRI_SAT) # making -100 into NA
df %>% summarize(n())

table(df$START_HOURS_NEAR_HOME_FRI_SAT)
df %>% summarize(n())
df$END_HOURS_NEAR_HOME_FRI_SAT <- sapply(df$END_HOURS_NEAR_HOME_FRI_SAT, convert_time)
# df <- df[df$END_HOURS_NEAR_HOME_FRI_SAT != "-100", ]
df %>% summarize(n())
df$END_HOURS_NEAR_HOME_FRI_SAT <- ifelse(df$END_HOURS_NEAR_HOME_FRI_SAT == -100, NA, df$END_HOURS_NEAR_HOME_FRI_SAT) # making -100 into NA
table(df$END_HOURS_NEAR_HOME_FRI_SAT)

df$START_HOURS_NEAR_HOME_SUN_THUR <- sapply(df$START_HOURS_NEAR_HOME_SUN_THUR, convert_time)
table(df$START_HOURS_NEAR_HOME_SUN_THUR)

df$END_HOURS_NEAR_HOME_SUN_THUR <- sapply(df$END_HOURS_NEAR_HOME_SUN_THUR, convert_time)
# df <- df[df$END_HOURS_NEAR_HOME_SUN_THUR != "-100", ]
df %>% summarize(n())
df$END_HOURS_NEAR_HOME_SUN_THUR <- ifelse(df$END_HOURS_NEAR_HOME_SUN_THUR == -100, NA, df$END_HOURS_NEAR_HOME_SUN_THUR) # making -100 into NA
table(df$END_HOURS_NEAR_HOME_SUN_THUR)

df <- df %>%
  mutate(EXISTING_ZONING = case_when(
    EXISTING_ZONING == "CBD - CENTRAL BUSINESS DISTRICT" ~ "CBD",
    EXISTING_ZONING == "CS - GENERAL COMMERCIAL" ~ "CS",
    EXISTING_ZONING == "SF-3 - FAMILY RESIDENCE" ~ "SF-3",
    EXISTING_ZONING == "TOD - TRANSIT ORIENTED DEVELOPMENT ZONING" ~ "TOD",
    EXISTING_ZONING == "CS-1 - LIQUOR SALES" ~ "CS-1",
    EXISTING_ZONING == "CS-MU-CO-Np Gen. Commercial-Mixed Use-Con. Overlay-Nbrhd Plan Comb dist" ~ "CS-MU-CO-NP",
    EXISTING_ZONING == "GR - COMMUNITY COMMERCIAL" ~ "GR",
    EXISTING_ZONING == "LR-NP Neighborhood Commercial-Neighborhood Plan Combining district" ~ "LR-NP",
    EXISTING_ZONING == "SF-3-NP - Family Residence-Neighborhood Plan Combining district" ~ "SF-3-NP",
    EXISTING_ZONING == "DMU - DOWNTOWN MIXED USE" ~ "DMU",
    TRUE ~ EXISTING_ZONING
  ))
unique(df$EXISTING_ZONING)

df$STREET_ADDRESS <- gsub("^[0-9]+(?:-[0-9/]+)?\\s+", "", df$STREET_ADDRESS)
unique(df$STREET_ADDRESS)

df %>% summarize(n())
sum(colSums(is.na(df)))
```

# Daniel: OMV Time Cleaning

```{r}
library(dplyr)

# Clean OMV times in original data set into nearest 24-hour format using floor
process_time <- function(x) {
  case_when(
    # Handle midnight/noon with case insensitivity and white space
    tolower(trimws(x)) == "midnight" ~ "00",
    tolower(trimws(x)) == "noon" ~ "12",
    
    # Convert specific values to NA
    tolower(trimws(x)) %in% c("no sound", "permitted", "sound", "no", "not") ~ NA_character_,
    
    # Preserve existing NAs
    is.na(x) ~ NA_character_,
    
    # Time conversion logic
    TRUE ~ {
      # Clean and standardize input
      clean_time <- gsub("[ .]", "", tolower(trimws(x)))
      
      # Check if the time is in AM/PM format
      is_am_pm <- grepl("[ap]m$", clean_time)
      
      # Extract hour and period for AM/PM times
      hour <- ifelse(is_am_pm, as.numeric(sub("^(\\d+):?\\d*[ap]m$", "\\1", clean_time)), NA)
      period <- ifelse(is_am_pm, sub("^.*([ap]m)$", "\\1", clean_time), NA)
      
      # Convert to 24-hour format for AM/PM times
      hour_24 <- ifelse(
        is_am_pm,
        ifelse(period == "pm",
               ifelse(hour == 12, 12, hour + 12),
               ifelse(hour == 12, 0, hour)),
        as.numeric(sub("^(\\d+):?\\d*$", "\\1", clean_time))  # Handle 24-hour times
      )
      
      # Validate and format as hour-only
      ifelse(!is.na(hour_24) & hour_24 >= 0 & hour_24 <= 23, sprintf("%02d", hour_24), NA_character_)
    }
  )
}

# Apply the function to all columns starting with "OMV"
df <- df %>%
  mutate(across(starts_with("OMV"), process_time))

```

# Daniel's Exploratory Graphing

```{r}
library(ggplot2)
library(stringr)

### -----------------"Issued by" vs "Total Amount of Permits"---------------###

# Save unique occurrences of ISSUED_BY and SUB_TYPE
diff_issued_names <- unique(df$ISSUED_BY)
diff_sub_types <- unique(df$SUB_TYPE)

# Count occurrences of ISSUED_BY and SUB_TYPE
permit_counts <- as.data.frame(table(df$ISSUED_BY, df$SUB_TYPE))
colnames(permit_counts) <- c("ISSUED_BY", "SUB_TYPE", "Count")

# Calculate and order by total permits
permit_counts$ISSUED_BY <- factor(permit_counts$ISSUED_BY,
                          levels = names(sort(tapply(permit_counts$Count, 
                          permit_counts$ISSUED_BY, sum), 
                          decreasing = TRUE)))

# Create a bar plot
ggplot(permit_counts, aes(x = ISSUED_BY, y = Count, fill = SUB_TYPE)) +
  geom_bar(stat = "identity", position = "stack", width = 0.8) +
  
  # Wrap labels to a width of 10 characters
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  
  labs(title = "Total Permits Given by Each Issuer with Sub-Type Breakdown",
       x = "Issuer",
       y = "Total Permits",
       fill = "Sub-Type") +
  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#_____________________________________________________________________________#

###---------------Average Time to get Approved by Issuer--------------------###

# Calculate average approval time
avg_days <- df %>%
  mutate(
    # Convert to Date type
    IN_DATE = as.Date(IN_DATE), 
     # Convert to Date type
    ISSUE_DATE = as.Date(ISSUE_DATE),
    # Calculate difference in days
    APPROVAL_DAYS = as.numeric(ISSUE_DATE - IN_DATE)
  ) %>%
  group_by(ISSUED_BY) %>%
  
  # Calculate average days
  summarize(AVG_DAYS = mean(APPROVAL_DAYS, na.rm = TRUE)) %>%  
  ungroup() %>%
  
  # Sort by AVG_DAYS in descending order
  arrange(desc(AVG_DAYS))  

# Reorder ISSUED_BY based on AVG_DAYS
avg_days$ISSUED_BY <- factor(avg_days$ISSUED_BY, levels = avg_days$ISSUED_BY)

# Create bar plot for average approval time by issuer
ggplot(avg_days, aes(x = ISSUED_BY, y = AVG_DAYS)) +
  geom_bar(stat = "identity", fill = "steelblue", width = 0.7) +
  scale_x_discrete(
    # Wrap labels to a width of 10 characters
    labels = function(x) str_wrap(x, width = 10)  
  ) +
  
  labs(
    title = "Average Approval Time by Issuer",
    x = "Issuer",
    y = "Average Approval Time (Days)"
  ) +
  
  theme_minimal() +
  theme(
    # Angle x-axis labels for readability
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.8), 
    # Add extra margin for label clearance
    plot.margin = margin(1, 1, 1.5, 1, "cm")
  )
#_____________________________________________________________________________#

###-----------------Average Start and End Times for OMV----------------------###

# Create day mappings
days <- c("MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN")
day_names <- c("Monday", "Tuesday", "Wednesday", "Thursday", 
              "Friday", "Saturday", "Sunday")

# Calculate time differences
time_diffs <- sapply(days, function(day) {
  start_col <- paste0("OMV_", day, "_START_TIME")
  end_col <- paste0("OMV_", day, "_END_TIME")
  
  # Convert to numeric
  start_times <- as.numeric(as.character(df[[start_col]]))
  end_times <- as.numeric(as.character(df[[end_col]]))
  
  # Calculate duration with overnight correction
  diffs <- ifelse(
    end_times < start_times,
    (end_times + 24) - start_times,
    end_times - start_times
  )
  
  mean(diffs, na.rm = TRUE)
})

# Create plotting data frame with ordered days
avg_omv_hours <- data.frame(
  Day = factor(day_names, levels = day_names),
  AvgHours = time_diffs
)

# Create the final plot with angled labels
ggplot(avg_omv_hours, aes(x = Day, y = AvgHours)) +
  geom_bar(stat = "identity", fill = "darkcyan", width = 0.7) +
  # Set y-axis range to 0-24 hours
  coord_cartesian(ylim = c(0, 24)) +  
  
  scale_y_continuous(
    # Breaks every 4 hours
    breaks = seq(0, 24, 4),  
    # Format as "00:00" to "24:00"
    labels = function(x) sprintf("%02d:00", x)  
  ) +
  
  labs(title = "Average OMV Operational Hours by Day",
       x = "Day of Week",
       y = "Average Hours (24h Format)") +
  
  theme_minimal() +
  # Angle x-axis labels for readability
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Nneoma is cleaning the values START_HOURS_NOT_NEAR_HOME, END_HOURS_NOT_NEAR_HOME, STATUS, EXPIRATION_DATE (YYYY-MM-DD), IN_DATE (YYYY-MM-DD), ISSUE_DATE, ISSUED_BY (YYYY-MM-DD), START_DATE, and has_multiple_start_dates

```{r}
# NNEOMA 
# the time here seems wrong
df$ISSUE_DATE <- ifelse(df$IN_DATE == "2011-11-01" & df$ISSUE_DATE == '2011-01-23', "2012-01-23", df$ISSUE_DATE)

# START_HOURS_NOT_NEAR_HOME --  converted string times into numeric numbers + created subset for them
# replaced that pending review with a NA value
df$START_HOURS_NOT_NEAR_HOME <- ifelse(df$START_HOURS_NOT_NEAR_HOME == "Pending Review", NA, df$START_HOURS_NOT_NEAR_HOME)
df$START_HOURS_NOT_NEAR_HOME <- gsub("an", "am", df$START_HOURS_NOT_NEAR_HOME) # fixed a typo
# changed 12:00 to 12:00PM
df$START_HOURS_NOT_NEAR_HOME <- ifelse(df$START_HOURS_NOT_NEAR_HOME == "12:00", "12:00 PM", df$START_HOURS_NOT_NEAR_HOME)

df$START_HOURS_NOT_NEAR_HOME <- sapply(df$START_HOURS_NOT_NEAR_HOME, convert_time) # converting column to numbers
# df$START_HOURS_NOT_NEAR_HOME <- ifelse(test$START_HOURS_NOT_NEAR_HOME == -100, NA, test$START_HOURS_NOT_NEAR_HOME) #making -100 into NA

# END_HOURS_NOT_NEAR_HOME - converted strings into numbers, made a subset of this data
table(df$END_HOURS_NOT_NEAR_HOME)
# removed pending review
df$END_HOURS_NOT_NEAR_HOME <- ifelse(df$END_HOURS_NOT_NEAR_HOME == "Pending Review", NA, df$END_HOURS_NOT_NEAR_HOME)
df$END_HOURS_NOT_NEAR_HOME <- gsub("A..M.", "am", df$END_HOURS_NOT_NEAR_HOME) # fixed a typo
df$END_HOURS_NOT_NEAR_HOME <- gsub("12:00 noon", "12:00pm", df$END_HOURS_NOT_NEAR_HOME) # fixed a typo
df$END_HOURS_NOT_NEAR_HOME <- gsub("12am & 1am", "12:00am", df$END_HOURS_NOT_NEAR_HOME) # 12AM 12AM,
df$END_HOURS_NOT_NEAR_HOME <- gsub("12AM 12AM,", "12:00am", df$END_HOURS_NOT_NEAR_HOME) # cleaning type
df$END_HOURS_NOT_NEAR_HOME <- ifelse(df$END_HOURS_NOT_NEAR_HOME == "2:00", "2:00PM", df$END_HOURS_NOT_NEAR_HOME) # fixing type

df$END_HOURS_NOT_NEAR_HOME <- sapply(df$END_HOURS_NOT_NEAR_HOME, convert_time) # converting column to numbers

df %>% summarize(n())
```

```{r}
library(dplyr)
# MAADHAV

head(df)

# ---AMPLIFIED_SOUND_DISTRICT------
# This columns has 3,262/6,455 missing values, so we can't drop all NAs
# Replacing with "Unknown" for now
num_nas <- sum(is.na(df$AMPLIFIED_SOUND_DISTRICT))
print(paste("Number of NAs:", num_nas, nrow(df)))
df$AMPLIFIED_SOUND_DISTRICT[is.na(df$AMPLIFIED_SOUND_DISTRICT)] <- "Unknown"

# Replacing "Withing 600ft of Residential" with "Residential"

df <- df %>%
  mutate(AMPLIFIED_SOUND_DISTRICT = ifelse(AMPLIFIED_SOUND_DISTRICT == "Within 600 ft of Residential", "Residential", AMPLIFIED_SOUND_DISTRICT))
# Replacing "Warehouse District" with "Warehouse"
df <- df %>%
  mutate(AMPLIFIED_SOUND_DISTRICT = ifelse(AMPLIFIED_SOUND_DISTRICT == "Warehouse District", "Warehouse", AMPLIFIED_SOUND_DISTRICT))

# Replacing "6th Street District" with "6th"
df <- df %>%
  mutate(AMPLIFIED_SOUND_DISTRICT = ifelse(AMPLIFIED_SOUND_DISTRICT == "6th Street District", "6th", AMPLIFIED_SOUND_DISTRICT))
unique(df$AMPLIFIED_SOUND_DISTRICT)


#----REST_51_PERCENT_FOOD_SALES-----
# Had ~5000 missing values, can't do too much about it
unique(df$REST_51_PERCENT_FOOD_SALES)
num_nas <- sum(is.na(df$REST_51_PERCENT_FOOD_SALES))
print(paste("Number of NAs:", num_nas, nrow(df)))

#---SQUARE_FOOTAGE------
# Had ~5000 missing values, exact same number as REST_51_PERCENT_FOOD_SALES
unique(df$SQUARE_FOOTAGE)
num_nas <- sum(is.na(df$SQUARE_FOOTAGE))
print(paste("Number of NAs:", num_nas, nrow(df)))

#----CAPACITY-----
# Had ~5000 missing values, exact same number as REST_51_PERCENT_FOOD_SALES
num_nas <- sum(is.na(df$CAPACITY))
print(paste("Number of NAs:", num_nas, nrow(df)))

#----DECIBEL_LEVEL-----
# ~3000 missing values
num_nas <- sum(is.na(df$DECIBEL_LEVEL))
print(paste("Number of NAs:", num_nas, nrow(df)))
unique(df$DECIBEL_LEVEL)

#-----SUB_TYPE------
# Data is clean, one category (Moving Vehicle) has only one record so I deleted it
num_nas <- sum(is.na(df$SUB_TYPE))
print(paste("Number of NAs:", num_nas, nrow(df)))
counts <- df %>%
  count(SUB_TYPE) %>%
  arrange(desc(n))

df <- df %>%
  filter(SUB_TYPE != "Moving Vehicle")
unique(df$SUB_TYPE)

#---EVENT_MONTH-----
# Removed 1600 missing values
num_nas <- sum(is.na(df$EVENT_MONTH))
print(paste("Number of NAs:", num_nas, nrow(df)))
nas <- df %>% filter(is.na(EVENT_MONTH))

#----CALENDAR_YEAR_FOLDER_CREATED------
# This column is removed
df %>% summarize(n())
```


### END OF DATA CLEANING. PUT ALL CODE BELOW
# Nneoma - Average start and End Times for Hours Not Near Home
```{r}
# install.packages("ggplot2", dependencies = TRUE)
library(ggplot2)  # Load the package

df %>% glimpse()

df_clean_start <- df %>% filter(!is.na(START_HOURS_NOT_NEAR_HOME))
df_clean_end <- df %>% filter(!is.na(END_HOURS_NOT_NEAR_HOME))

# boxplot code
ggplot(df_clean_start) + 
  geom_boxplot(aes(x = factor(1), y = START_HOURS_NOT_NEAR_HOME), fill = "blue", alpha = 0.6) + 
  geom_boxplot(aes(x = factor(2), y = END_HOURS_NOT_NEAR_HOME), fill = "red", alpha = 0.6) + 
  scale_x_discrete(labels = c("Start", "End")) + 
  labs(title = "Boxplot of Start & End Times", y = "Hour")


# Bar plot of start times using a gradient color scale 
# does NOT include cols with 0 counts - if important i can try to figure it out
ggplot(df_clean_start, aes(x = factor(START_HOURS_NOT_NEAR_HOME), fill = START_HOURS_NOT_NEAR_HOME)) +
  geom_bar(stat = "count", na.rm = TRUE) +
  scale_fill_gradient2(low = "darkblue", mid = "yellow", high = "darkblue", midpoint = 12) +
  theme_minimal() +
  labs(x = "Start Hour", y = "Count", fill = "Hour of Day")

ggplot(df_clean_end, aes(x = factor(END_HOURS_NOT_NEAR_HOME), fill = END_HOURS_NOT_NEAR_HOME)) +
  geom_bar(stat = "count", na.rm = TRUE) +
  scale_fill_gradient2(low = "darkblue", mid = "yellow", high = "darkblue", midpoint = 12) +
  theme_minimal() +
  labs(x = "End Hour", y = "Count", fill = "Hour of Day")



# df_clean_start %>% summarize(mean(START_HOURS_NOT_NEAR_HOME))
# df_clean_end %>% summarize(mean(END_HOURS_NOT_NEAR_HOME))
print('The average start time is 1:30PM and the average end time is 2PM')

# --------------------------------------------------------------------------------------

# time between date applied and date issued (overall)
head(df$IN_DATE, 5) #application date
head(df$ISSUE_DATE, 5) 
head(df$START_DATE, 5)  # last then - not every in-issue has a start date


df_times <- df %>%
  mutate(time_diff = as.numeric(difftime(ISSUE_DATE, IN_DATE, units = "days")))

# histogram with each bin representing 30 days
ggplot(df_times, aes(x = time_diff)) + 
  geom_histogram(binwidth = 30, fill = "lightblue", color = "black", alpha = 0.7) + 
  labs(x = "Time Difference (Days)", y = "Frequency", title = "Histogram of Time Differences Between Application and Permit Issuance") +
  scale_x_continuous(
    breaks = seq(0, max(df_times$time_diff), by = 30),  # Adjust the 'by' value to match your binwidth
    labels = seq(0, max(df_times$time_diff), by = 30)   # Labels for each bin
  ) +
  theme_minimal()

# df_times %>% summarize(mean(time_diff))
print('The average time applicants wait for their permits to be issued is 19.6 days')

# I want to see the average time difference bassed on the date applied by MONTH
df_times <- df_times %>% mutate(IN_DATE = as.Date(IN_DATE),
    ISSUE_DATE = as.Date(ISSUE_DATE),in_mon = format(IN_DATE, "%B"), issue_mon = format(ISSUE_DATE, "%B")) %>% 
    mutate(in_mon = factor(in_mon, levels = month.name), issue_mon = factor(issue_mon, levels = month.name))
df_avg_td_mon <- df_times %>% group_by(in_mon) %>% summarize(avg_time_diff = mean(time_diff), sd_time_diff = sd(time_diff))

ggplot(df_avg_td_mon, aes(x=in_mon, y=avg_time_diff,  fill = as.numeric(factor(in_mon, levels = month.name)))) + geom_bar(stat = 'identity') +
scale_fill_gradient2(low = "blue", mid = "red", high = "blue", midpoint = 6) + 
geom_errorbar(
    aes(ymin = avg_time_diff - sd_time_diff, ymax = avg_time_diff + sd_time_diff), 
    width = 0.2,  # Adjust error bar width
    color = "red"  # Error bars in red
  ) + labs(title='Average Time between Permit Issuance and Application by Month', x='Months Applied', y='Average Time to Get Permit Issued (days)')

# These are the times of the month that people apply for permits
df_cnts = df_times %>% group_by(in_mon) %>% summarize(permit_cnt = n())
ggplot(df_cnts, aes(x = in_mon, y = permit_cnt, fill = as.numeric(factor(in_mon, levels = month.name)))) + geom_bar(stat = 'identity') + scale_fill_gradient2(low = "blue", mid = "red", high = "blue", midpoint = 6)
+ labs('Months Where People Apply for a Permit', x='Application Months', y='Number of Permit Applications') 

# These are the times of the month permits get issued
df_iss_cnts = df_times %>% group_by(issue_mon) %>% summarize(permit_cnt = n())
ggplot(df_iss_cnts, aes(x = issue_mon, y = permit_cnt, fill = as.numeric(factor(issue_mon, levels = month.name)))) + geom_bar(stat = 'identity') + scale_fill_gradient2(low = "blue", mid = "red", high = "blue", midpoint = 6)
+ labs('Months Where Permist get Issued', x='Issue Months', y='Number of Permit Applications') 

# I COULD break it down from here but i decided to stop from now - lmk how yall feel about it later

  
# --------------------------------------------------------------------------------------




```


```{r}
# GREG VISUALIZATIONS

# ALL PERMITS BY MONTH
library(ggplot2)
permits_by_month <- df %>%
    filter(!is.na(EVENT_MONTH)) %>%
    count(EVENT_MONTH)

permits_by_month$EVENT_MONTH <- factor(permits_by_month$EVENT_MONTH, levels = toupper(month.name))

ggplot(permits_by_month, aes(x = EVENT_MONTH, y = n)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    labs(title = "Number of Permits by Month",
         x = "Month",
         y = "Number of Permits") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))




# CONCRETE PERMITS BY MONTH
construction_by_month <- df %>%
    filter(!is.na(EVENT_MONTH)) %>%
    filter(SUB_TYPE == 'Concrete Pouring') %>%
    count(EVENT_MONTH)

construction_by_month$EVENT_MONTH <- factor(permits_by_month$EVENT_MONTH, levels = toupper(month.name))

ggplot(construction_by_month, aes(x = EVENT_MONTH, y = n)) +
  geom_bar(stat = "identity", fill = "purple") +  # Bar chart with color
  labs(title = "Number of Construction Permits by Month",
       x = "Month",
       y = "Number of Construction Permits") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



# CONCERT PERMITS BY YEAR (month was missing for all concerts except 1)
concerts_by_year <- df %>%
    filter(!is.na(EVENT_YEAR)) %>%
    filter(SUB_TYPE == 'Outdoor Music Venue') %>%
    count(EVENT_YEAR)

ggplot(concerts_by_year, aes(x = EVENT_YEAR, y = n)) +
  geom_bar(stat = "identity", fill = "salmon") +  # Bar chart with color
  labs(title = "Number of Concerts by Year",
       x = "Year",
       y = "Number of Concerts") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  #




# CONCRETE PERMITS BY YEAR (month was missing for all of them)
construction_by_year <- df %>%
    filter(!is.na(EVENT_YEAR)) %>%
    filter(SUB_TYPE == 'Concrete Pouring') %>%
    count(EVENT_YEAR)

ggplot(construction_by_year, aes(x = EVENT_YEAR, y = n)) +
  geom_bar(stat = "identity", fill = "green") +  # Bar chart with color
  labs(title = "Number of Construction Permits by Year",
       x = "Year",
       y = "Number of Construction Permits") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  




# ALL PERMITS BY YEAR
all_by_year <- df %>%
    filter(!is.na(EVENT_YEAR)) %>%
    count(EVENT_YEAR)

ggplot(all_by_year, aes(x = EVENT_YEAR, y = n)) +
  geom_bar(stat = "identity", fill = "blue") +  # Bar chart with color
  labs(title = "Total Permits by Year",
       x = "Year",
       y = "Total Permits") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  


# ALL PERMITS BY MONTH DENSITY PLOT
ggplot(df %>% filter(EVENT_MONTH %in% toupper(month.name)),  # Remove "NA"
       aes(x = factor(EVENT_MONTH, levels = toupper(month.name)), group = 1)) +  
  geom_density(aes(fill = SUB_TYPE, color = SUB_TYPE), alpha = 0.4) +
  labs(title = "Permit Submissions by Month",
       x = "Event Month",
       y = "Density") +
  scale_x_discrete(expand = c(0.1, 0.1)) +  
  scale_y_continuous(expand = c(0.1, 0.1)) +  
  facet_wrap(~ SUB_TYPE, scales = "fixed", ncol = 2) +  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 7))

```

